"use strict";exports.Mutex=t=>{const e={};let o=0,i=!1;const s=[],l=(i,s,l)=>{let n=e[`${l?.key}`];n||(n={l:0,r:[]},e[`${l?.key}`]=n);const c=l?.limit&&n.l>=l.limit||o>=(t?.globalLimit||1),u=c&&t?.timeout?setTimeout((()=>{const t=new Error("timeout");t.code=1,s(t)}),t.timeout):void 0,m=()=>i((()=>{clearTimeout(u),r(l)}));c&&n.r.push([m,l?.index||0]),o++,n.l++,c||m()},r=t=>{const i=e[`${t?.key}`];i&&(0!==i.r.length&&i.r.sort(((t,e)=>t[1]-e[1])).shift()?.[0](t),i.l--),o--};return{wait:t=>new Promise(((e,o)=>{i?s.push((()=>{l(e,o,t)})):l(e,o,t)})),release:r,lock:()=>{i=!0},unlock:()=>{for(i=!1;s.length>0;){const t=s.shift();t&&t()}}}};
